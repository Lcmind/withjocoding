// 번역
const translations = {
  ko: {
    title: '조준 트레이너',
    subtitle: '조준 정확도와 속도를 향상시키세요!',
    selectDifficulty: '난이도 선택',
    easy: '쉬움',
    normal: '보통',
    hard: '어려움',
    startTraining: '훈련 시작',
    bestAccuracy: '최고 정확도',
    targets: '타겟',
    accuracy: '정확도',
    combo: '콤보',
    results: '결과',
    finalAccuracy: '최종 정확도',
    avgTime: '평균 시간',
    maxCombo: '최대 콤보',
    score: '점수',
    trainAgain: '다시 훈련',
    backHome: '홈으로',
    privacyPolicy: '개인정보처리방침',
    termsOfService: '이용약관'
  },
  en: {
    title: 'Aim Trainer',
    subtitle: 'Improve your aim precision and speed!',
    selectDifficulty: 'Select Difficulty',
    easy: 'Easy',
    normal: 'Normal',
    hard: 'Hard',
    startTraining: 'Start Training',
    bestAccuracy: 'Best Accuracy',
    targets: 'Targets',
    accuracy: 'Accuracy',
    combo: 'Combo',
    results: 'Results',
    finalAccuracy: 'Final Accuracy',
    avgTime: 'Avg Time',
    maxCombo: 'Max Combo',
    score: 'Score',
    trainAgain: 'Train Again',
    backHome: 'Home',
    privacyPolicy: 'Privacy Policy',
    termsOfService: 'Terms of Service'
  },
  ja: {
    title: 'エイムトレーナー',
    subtitle: 'エイムの精度とスピードを向上させよう！',
    selectDifficulty: '難易度選択',
    easy: '簡単',
    normal: '普通',
    hard: '難しい',
    startTraining: 'トレーニング開始',
    bestAccuracy: '最高精度',
    targets: 'ターゲット',
    accuracy: '精度',
    combo: 'コンボ',
    results: '結果',
    finalAccuracy: '最終精度',
    avgTime: '平均時間',
    maxCombo: '最大コンボ',
    score: 'スコア',
    trainAgain: '再トレーニング',
    backHome: 'ホーム',
    privacyPolicy: 'プライバシーポリシー',
    termsOfService: '利用規約'
  },
  zh: {
    title: '瞄准训练器',
    subtitle: '提高你的瞄准精度和速度！',
    selectDifficulty: '选择难度',
    easy: '简单',
    normal: '普通',
    hard: '困难',
    startTraining: '开始训练',
    bestAccuracy: '最佳精度',
    targets: '目标',
    accuracy: '精度',
    combo: '连击',
    results: '结果',
    finalAccuracy: '最终精度',
    avgTime: '平均时间',
    maxCombo: '最大连击',
    score: '分数',
    trainAgain: '再次训练',
    backHome: '主页',
    privacyPolicy: '隐私政策',
    termsOfService: '服务条款'
  },
  es: {
    title: 'Entrenador de Puntería',
    subtitle: '¡Mejora tu precisión y velocidad de puntería!',
    selectDifficulty: 'Seleccionar Dificultad',
    easy: 'Fácil',
    normal: 'Normal',
    hard: 'Difícil',
    startTraining: 'Comenzar Entrenamiento',
    bestAccuracy: 'Mejor Precisión',
    targets: 'Objetivos',
    accuracy: 'Precisión',
    combo: 'Combo',
    results: 'Resultados',
    finalAccuracy: 'Precisión Final',
    avgTime: 'Tiempo Promedio',
    maxCombo: 'Combo Máximo',
    score: 'Puntuación',
    trainAgain: 'Entrenar de Nuevo',
    backHome: 'Inicio',
    privacyPolicy: 'Política de Privacidad',
    termsOfService: 'Términos de Servicio'
  },
  fr: {
    title: 'Entraîneur de Visée',
    subtitle: 'Améliorez votre précision et vitesse de visée !',
    selectDifficulty: 'Sélectionner la Difficulté',
    easy: 'Facile',
    normal: 'Normal',
    hard: 'Difficile',
    startTraining: 'Commencer l\'Entraînement',
    bestAccuracy: 'Meilleure Précision',
    targets: 'Cibles',
    accuracy: 'Précision',
    combo: 'Combo',
    results: 'Résultats',
    finalAccuracy: 'Précision Finale',
    avgTime: 'Temps Moyen',
    maxCombo: 'Combo Maximum',
    score: 'Score',
    trainAgain: 'Réessayer',
    backHome: 'Accueil',
    privacyPolicy: 'Politique de Confidentialité',
    termsOfService: 'Conditions d\'Utilisation'
  },
  de: {
    title: 'Ziel-Trainer',
    subtitle: 'Verbessere deine Zielpräzision und Geschwindigkeit!',
    selectDifficulty: 'Schwierigkeit Wählen',
    easy: 'Einfach',
    normal: 'Normal',
    hard: 'Schwer',
    startTraining: 'Training Starten',
    bestAccuracy: 'Beste Genauigkeit',
    targets: 'Ziele',
    accuracy: 'Genauigkeit',
    combo: 'Kombo',
    results: 'Ergebnisse',
    finalAccuracy: 'Endgültige Genauigkeit',
    avgTime: 'Durchschnittliche Zeit',
    maxCombo: 'Maximales Kombo',
    score: 'Punktzahl',
    trainAgain: 'Erneut Trainieren',
    backHome: 'Startseite',
    privacyPolicy: 'Datenschutzrichtlinie',
    termsOfService: 'Nutzungsbedingungen'
  },
  pt: {
    title: 'Treinador de Mira',
    subtitle: 'Melhore sua precisão e velocidade de mira!',
    selectDifficulty: 'Selecionar Dificuldade',
    easy: 'Fácil',
    normal: 'Normal',
    hard: 'Difícil',
    startTraining: 'Começar Treinamento',
    bestAccuracy: 'Melhor Precisão',
    targets: 'Alvos',
    accuracy: 'Precisão',
    combo: 'Combo',
    results: 'Resultados',
    finalAccuracy: 'Precisão Final',
    avgTime: 'Tempo Médio',
    maxCombo: 'Combo Máximo',
    score: 'Pontuação',
    trainAgain: 'Treinar Novamente',
    backHome: 'Início',
    privacyPolicy: 'Política de Privacidade',
    termsOfService: 'Termos de Serviço'
  },
  ru: {
    title: 'Тренажер Прицеливания',
    subtitle: 'Улучши свою точность и скорость прицеливания!',
    selectDifficulty: 'Выбрать Сложность',
    easy: 'Легко',
    normal: 'Нормально',
    hard: 'Сложно',
    startTraining: 'Начать Тренировку',
    bestAccuracy: 'Лучшая Точность',
    targets: 'Цели',
    accuracy: 'Точность',
    combo: 'Комбо',
    results: 'Результаты',
    finalAccuracy: 'Итоговая Точность',
    avgTime: 'Среднее Время',
    maxCombo: 'Максимальное Комбо',
    score: 'Счет',
    trainAgain: 'Тренироваться Снова',
    backHome: 'Главная',
    privacyPolicy: 'Политика Конфиденциальности',
    termsOfService: 'Условия Использования'
  },
  ar: {
    title: 'مدرب التصويب',
    subtitle: 'حسّن دقتك وسرعتك في التصويب!',
    selectDifficulty: 'اختر الصعوبة',
    easy: 'سهل',
    normal: 'عادي',
    hard: 'صعب',
    startTraining: 'ابدأ التدريب',
    bestAccuracy: 'أفضل دقة',
    targets: 'الأهداف',
    accuracy: 'الدقة',
    combo: 'كومبو',
    results: 'النتائج',
    finalAccuracy: 'الدقة النهائية',
    avgTime: 'متوسط الوقت',
    maxCombo: 'أقصى كومبو',
    score: 'النقاط',
    trainAgain: 'تدرب مجدداً',
    backHome: 'الصفحة الرئيسية',
    privacyPolicy: 'سياسة الخصوصية',
    termsOfService: 'شروط الخدمة'
  }
};

let currentLang = localStorage.getItem('preferredLanguage') || 'en';
const languageSelector = document.getElementById('language-selector');
if (languageSelector) {
  languageSelector.value = currentLang;
}

function t(key) {
  return translations[currentLang][key] || key;
}

function updateLanguage() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    el.textContent = t(key);
  });
}

if (languageSelector) {
  languageSelector.addEventListener('change', (e) => {
    currentLang = e.target.value;
    localStorage.setItem('preferredLanguage', currentLang);
    updateLanguage();
  });
}

updateLanguage();

// 게임 로직
let difficulty = 'normal';
let targetCount = 0;
const maxTargets = 30;
let hits = 0;
let misses = 0;
let combo = 0;
let maxCombo = 0;
let reactionTimes = [];
let targetAppearTime = 0;
let isTargetVisible = false;

const difficultySettings = {
  easy: { size: 100, delay: [1000, 1500], lifetime: 2000 },
  normal: { size: 70, delay: [500, 1000], lifetime: 1500 },
  hard: { size: 50, delay: [300, 700], lifetime: 1000 }
};

const target = document.getElementById('target');
const clickEffect = document.getElementById('click-effect');
const gameArea = document.getElementById('game-area');

// 난이도 선택
document.querySelectorAll('.difficulty-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.difficulty-btn').forEach(b => {
      b.classList.remove('active', 'border-orange-500', 'bg-gradient-to-br', 'from-orange-500', 'to-red-600', 'text-white', 'shadow-lg');
      b.classList.add('border-gray-300');
    });
    btn.classList.remove('border-gray-300');
    btn.classList.add('active', 'border-orange-500', 'bg-gradient-to-br', 'from-orange-500', 'to-red-600', 'text-white', 'shadow-lg');
    difficulty = btn.dataset.difficulty;
  });
});

document.getElementById('start-btn').addEventListener('click', startGame);
document.getElementById('retry-btn').addEventListener('click', () => {
  hideScreen(document.getElementById('result-screen'));
  showScreen(document.getElementById('start-screen'));
});
document.getElementById('home-btn').addEventListener('click', () => {
  window.location.href = 'index.html';
});

function startGame() {
  hideScreen(document.getElementById('start-screen'));
  showScreen(document.getElementById('game-screen'));

  initGame();
}

function initGame() {
  targetCount = 0;
  hits = 0;
  misses = 0;
  combo = 0;
  maxCombo = 0;
  reactionTimes = [];
  isTargetVisible = false;

  updateGameInfo();
  spawnTarget();

  // 빗나간 클릭 감지
  gameArea.onclick = (e) => {
    if (e.target !== target && isTargetVisible) {
      misses++;
      combo = 0;
      updateGameInfo();
      showClickEffect(e.clientX, e.clientY, false);
    }
  };
}

function spawnTarget() {
  if (targetCount >= maxTargets) {
    endGame();
    return;
  }

  const settings = difficultySettings[difficulty];
  const margin = settings.size;
  const maxX = window.innerWidth - margin * 2;
  const maxY = window.innerHeight - margin * 2 - 100;

  const randomX = Math.random() * maxX + margin;
  const randomY = Math.random() * maxY + margin + 100;

  // 타겟 설정
  target.style.left = `${randomX}px`;
  target.style.top = `${randomY}px`;
  target.style.width = `${settings.size}px`;
  target.style.height = `${settings.size}px`;
  target.className = 'absolute rounded-full transition-all duration-200 shadow-2xl border-4 border-white/30 bg-gradient-to-br from-orange-500 to-red-600';

  // 랜덤 색상 (매번 다름)
  const colors = [
    'from-orange-500 to-red-600',
    'from-red-500 to-pink-600',
    'from-yellow-500 to-orange-600',
    'from-purple-500 to-pink-600',
    'from-blue-500 to-purple-600'
  ];
  const randomColor = colors[Math.floor(Math.random() * colors.length)];
  target.classList.add('bg-gradient-to-br', ...randomColor.split(' '));

  // 타겟 표시
  setTimeout(() => {
    target.classList.remove('opacity-0', 'scale-0');
    target.classList.add('opacity-100', 'scale-100', 'target-pulse');
    isTargetVisible = true;
    targetAppearTime = Date.now();

    // 일정 시간 후 자동 사라짐 (미스 처리)
    setTimeout(() => {
      if (isTargetVisible) {
        missTarget();
      }
    }, settings.lifetime);
  }, getRandomDelay(settings.delay[0], settings.delay[1]));

  // 타겟 클릭
  target.onclick = (e) => {
    if (!isTargetVisible) return;
    e.stopPropagation();

    const reactionTime = Date.now() - targetAppearTime;
    reactionTimes.push(reactionTime);
    hits++;
    combo++;
    if (combo > maxCombo) maxCombo = combo;

    hideTarget();
    showClickEffect(e.clientX, e.clientY, true);
    updateGameInfo();

    targetCount++;
    setTimeout(() => spawnTarget(), 200);
  };
}

function missTarget() {
  if (!isTargetVisible) return;

  misses++;
  combo = 0;
  hideTarget();
  updateGameInfo();

  targetCount++;
  setTimeout(() => spawnTarget(), 500);
}

function hideTarget() {
  isTargetVisible = false;
  target.classList.remove('opacity-100', 'scale-100', 'target-pulse');
  target.classList.add('opacity-0', 'scale-0');
}

function showClickEffect(x, y, isHit) {
  clickEffect.style.left = `${x - 50}px`;
  clickEffect.style.top = `${y - 50}px`;
  clickEffect.className = `absolute w-24 h-24 border-4 rounded-full pointer-events-none ${isHit ? 'border-green-500' : 'border-red-500'}`;

  clickEffect.classList.remove('opacity-0', 'scale-0');
  clickEffect.classList.add('hit-effect-anim');

  setTimeout(() => {
    clickEffect.classList.add('opacity-0', 'scale-0');
    clickEffect.classList.remove('hit-effect-anim');
  }, 400);
}

function updateGameInfo() {
  document.getElementById('target-count').textContent = `${targetCount} / ${maxTargets}`;

  const totalShots = hits + misses;
  const accuracy = totalShots > 0 ? Math.round((hits / totalShots) * 100) : 100;
  document.getElementById('accuracy-display').textContent = `${accuracy}%`;

  document.getElementById('combo-display').textContent = `x${combo}`;
  if (combo >= 5) {
    document.getElementById('combo-display').classList.add('text-yellow-400');
  } else {
    document.getElementById('combo-display').classList.remove('text-yellow-400');
  }
}

function endGame() {
  const totalShots = hits + misses;
  const accuracy = totalShots > 0 ? Math.round((hits / totalShots) * 100) : 100;
  const avgTime = reactionTimes.length > 0
    ? Math.round(reactionTimes.reduce((a, b) => a + b) / reactionTimes.length)
    : 0;
  const score = Math.round(hits * 100 * (1 + combo / 10));

  document.getElementById('final-accuracy').textContent = `${accuracy}%`;
  document.getElementById('avg-time').textContent = `${avgTime}ms`;
  document.getElementById('max-combo').textContent = `x${maxCombo}`;
  document.getElementById('final-score').textContent = score;

  // 최고 기록 저장
  const key = `aimBest_${difficulty}`;
  const best = localStorage.getItem(key);
  if (!best || accuracy > parseInt(best)) {
    localStorage.setItem(key, accuracy);
  }

  hideScreen(document.getElementById('game-screen'));
  showScreen(document.getElementById('result-screen'));
}

function getRandomDelay(min, max) {
  return Math.random() * (max - min) + min;
}

function showScreen(screen) {
  screen.classList.remove('hidden');
  screen.classList.add('active');
}

function hideScreen(screen) {
  screen.classList.add('hidden');
  screen.classList.remove('active');
}

function loadBestRecord() {
  const key = `aimBest_${difficulty}`;
  const best = localStorage.getItem(key);
  document.getElementById('best-record').textContent = best ? `${best}%` : '--%';
}

loadBestRecord();
